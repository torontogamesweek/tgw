<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toronto Games Week</title>

    <!-- Stylesheets -->
    <link href="../styles.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=PT+Mono&display=swap" rel="stylesheet" />

    <!-- Meta Tags -->
    <meta name="author" content="Marie Claire LeBlanc Flanagan" />
    <meta name="description" content="Celebrating games in Toronto, Canada" />

    <!--a Open Graph Tags -->
    <meta property="og:title" content="Toronto Games Week" />
    <meta property="og:description" content="Celebrating games in Toronto, Canada" />
    <meta property="og:image" content="https://torontogamesweek.com/images/tgwposternologos.png" />
    <meta property="og:url" content="https://torontogamesweek.com" />
    <meta property="og:type" content="webpage" />

    <!-- Twitter Tags -->
    <meta name="twitter:title" content="Toronto Games Week" />
    <meta name="twitter:description" content="Celebrating games in Toronto, Canada" />
    <meta name="twitter:image" content="images/TGWSocialSmall.png" id="indexImage" />
    <meta name="twitter:card" content="summary_large_image" />

    <style>
      /* Base canvas setup */
      canvas {
        position: absolute; /* Mobile default */
        width: 100%;
        background-image: none;
        height: auto;
        left: 0;
        top: 0;
      }

      .image-container {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        height: calc(1000px * (9 / 16)); /* Assuming 16:9 aspect ratio, adjust to match actual image ratio */
      }

      main {
        position: relative;
        z-index: 1;
        margin-top: 0;
        background-color: none;
      }

      header {
        margin-top: 0;
      }

      #linkBold2025 {
        font-weight: bold;
        color: #5f32f3;
      }

      #main2025 {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
        padding: 10px 5px;
        background-image: url("images/2025/lcolour.jpg");
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: top;
        background-size: cover;
      }

      @media (min-width: 768px) {
        #main2025 {
          padding: 8rem 2rem;
        }
      }

      #topboxcontainer2025 {
        margin-top: 15rem;
        /* margin: 0 2px; */
      }

      @media (min-width: 768px) {
        #topboxcontainer2025 {
          /* margin: 0 15rem; */
        }
      }

      #topbox2025 {
        font-size: 1.5rem;
      }

      #primary-navigation {
        z-index: 50;
      }

      .contentContainer {
        position: relative;
        z-index: 1;
      }

      /* Content container setup */
      .contentContainer,
      .sponsorBox {
        position: relative;
        z-index: 1;
        pointer-events: none;
      }

      .headerImgDiv {
        z-index: 1;
        pointer-events: none;
        background-color: transparent;
      }

      /* Main content areas */
      .content {
        pointer-events: none;
      }

      .textBox2025 {
        /* max-width: 85vw; */
        position: relative;
        min-width: 100%;
        display: flex;
        flex-direction: column;
        margin: 0 auto 0 auto;
        /* padding: 1.5rem; */
        /* padding: 0 2rem 2rem 3rem; */

        border-radius: 10px;
        background-color: hsla(0, 0%, 100%, 0.9);
        pointer-events: none;
        text-align: center;
        align-items: center;
        /* max-width: 98vw; */
        /* padding: 4rem 10rem; */
      }

      @media (min-width: 768px) {
        .textBox2025 {
          padding: 8rem 2rem;
        }
      }

      button:hover {
        /* expand a bit */
        transform: scale(1.1);
        transition: transform 0.2s ease-in-out;
      }

      .categoryContainer2025 {
        margin: 1rem 0 0;
      }

      .category2025 {
        text-transform: lowercase;
        /* margin: 2rem 0 1rem 1rem; */
        background: rgba(221, 213, 230, 0.9);
        color: #5f32f3;
        padding: 0.15rem 0.3rem;
        border-radius: 13px;
        font-size: 0.9rem;
        display: inline-block; /* keep the background color wrapped tight */
        font-family: "Alegreya", sans-serif;
        margin: 0.25rem 0.25rem;
      }

      #daySelectorSelected {
        background-color: rgba(218, 194, 247, 0.3);
        color: #bbbbbb;
        font-weight: bold;
      }

      .weekendColorOne {
        /* light-medium blue */
        background-color: #4c8bb8;
      }

      .weekendColorTwo {
        /* Deep Blue */
        background-color: #045888;
      }

      .weekendColorThree {
        /* Medium Blue */
        background-color: #4f8cc9;
      }

      .saveEvent {
        background-color: #4c8bb8;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        /* Fix to top right */
        position: absolute;
        top: 1rem;
        right: 1rem;
      }

      #img2025 {
        max-height: 8rem;
      }

      #title2025 {
        font-size: 2rem;
      }

      #description2025 {
        font-size: 1rem;
      }

      a {
        font-size: 1rem;
      }

      p {
        font-size: 1rem;
      }

      #schedule-container {
        width: 100%;
      }

      @media (min-width: 768px) {
        #schedule-container {
          /* 3 per row in the grid with them all the same size */
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
          gap: 2rem;
        }
      }

      #date2025 {
        font-size: 1.5rem;
        font-weight: bold;
      }

      @media (min-width: 768px) {
        .textBox2025 {
          /* padding: 4rem 10rem; */
        }
      }

      /* Re-enable pointer events for specific interactive elements */
      .contentContainer > * .headerImgDiv img,
      .btn,
      .floatingBtn,
      .textBox2025 > * {
        pointer-events: all;
        z-index: 2;
      }

      #allDaysButton {
        background-color: #800077;
        color: white;
      }

      /* Header */
      nav {
        position: static;
      }

      nav a {
        pointer-events: auto;
        background-color: white;
      }

      nav ul {
        background-color: rgb(255, 255, 255);
      }

      @media screen and (min-width: 900px) {
      }

      @media (min-width: 768px) {
        header {
          height: 0;
        }

        canvas {
          position: absolute; /* Reset for desktop */
        }

        nav li,
        nav ul,
        nav {
          background-color: rgba(255, 255, 255, 0);
          padding: 10px 10px 0 10px;
        }

        nav {
          margin: 0;
          padding: 0;
          background-color: rgba(255, 255, 255, 0);
        }
        nav a {
          color: rgb(45, 45, 45); /* Adjust based on background */
          text-shadow: 0 0 5px white; /* Soft glow effect */
          background-color: rgba(255, 255, 255, 0);
        }

        nav > ul > li {
          font-size: 1.5rem;
          margin: 0 10px;
        }

        header {
          position: relative;
        }
      }

      /* Mobile styles */
      @media (max-width: 768px) {
        .sponsorBox {
          margin: 4rem 0 0 0;
        }

        .logo-container {
          grid-template-columns: repeat(3, 1fr);
          gap: 1rem;
        }

        .logo-slot {
          width: 100px;
          height: 60px;
        }

        /* Hide slots 4-6 on mobile */
        .logo-slot:nth-child(n + 4) {
          display: none;
        }
      }

      .no-pointer-events {
        pointer-events: none;
      }

      /* Base */
      main {
        position: relative;
        z-index: 1;
      }
    </style>
  </head>

  <body>
    <header>
      <button id="nav-toggle" aria-expanded="false" aria-controls="primary-navigation" class="nav-toggle-button">
        <span class="sr-only">Menu</span>
        <span class="icon"></span>
      </button>

      <nav id="primary-navigation">
        <ul>
          <li>
            <a href="./index.html">Home</a>
          </li>
          <li>
            <a href="schedule.html" id="scheduleNav">Schedule</a>
          </li>
          <li>
            <a href="about.html" id="aboutNav">About</a>
          </li>
        </ul>
      </nav>
    </header>

    <main class="no-pointer-events" id="main2025">
      <!-- Add HTML here -->

      <div id="topboxcontainer2025">
        <section class="textBox2025">
          <p id="topbox2025">
            <b>Toronto Games Week</b> takes place from June 12th to June 18th! Explore the many events and activities happening throughout the week.
          </p>
          <section class="textBox-btn" id="daySelector">
            <button role="button" href="#day1" class="btn-d1 weekendColorOne" data-day="Thu 12">
              Th<br />
              12
            </button>
            <button role="button" href="#day2" class="btn-d2 weekendColorOne" data-day="Fri 13">Fr<br />13</button>
            <button role="button" href="#day3" class="btn-d3 weekendColorTwo" data-day="Sat 14">Sa<br />14</button>
            <button role="button" href="#day4" class="btn-d4 weekendColorTwo" data-day="Sun 15">Su<br />15</button>
            <button role="button" href="#day5" class="btn-d5 weekendColorThree" data-day="Mon 16">Mo<br />16</button>
            <button role="button" href="#day6" class="btn-d6 weekendColorThree" data-day="Tue 17">Tu<br />17</button>
            <button role="button" href="#day7" class="btn-d7 weekendColorThree" data-day="Wed 18">We<br />18</button>

            <button role="button" class="btn-d1 btn-all weekendColorThree" data-day="All" id="allDaysButton">All<br />Days</button>
          </section>
        </section>
      </div>
      <div id="schedule-container"></div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const navToggle = document.getElementById("nav-toggle");
        const primaryNav = document.getElementById("primary-navigation");

        navToggle.addEventListener("click", function () {
          const isExpanded = navToggle.getAttribute("aria-expanded") === "true";
          navToggle.setAttribute("aria-expanded", !isExpanded);
          primaryNav.classList.toggle("expanded");
        });
      });
    </script>
    <script>
      // Add Javascript Here

      // Parse CSV with proper handling of newlines in quoted fields
      const parseCSV = (csvText) => {
        const result = [];
        let row = [];
        let currentValue = "";
        let insideQuotes = false;

        for (let i = 0; i < csvText.length; i++) {
          const char = csvText[i];
          const nextChar = csvText[i + 1];

          if (char === '"' && (!insideQuotes || nextChar !== '"')) {
            // Toggle quote state (but not for escaped quotes)
            insideQuotes = !insideQuotes;
            continue;
          }

          if (char === '"' && nextChar === '"') {
            // Handle escaped quotes (double quotes)
            currentValue += '"';
            i++; // Skip the next quote
            continue;
          }

          if (char === ";" && !insideQuotes) {
            // End of field
            row.push(currentValue);
            currentValue = "";
            continue;
          }

          if ((char === "\n" || (char === "\r" && nextChar === "\n")) && !insideQuotes) {
            // End of row
            row.push(currentValue);
            result.push(row);
            row = [];
            currentValue = "";
            if (char === "\r") i++; // Skip \n if we encountered \r\n
            continue;
          }

          // Regular character, add to current value
          currentValue += char;
        }

        // Don't forget the last row/value if file doesn't end with newline
        if (currentValue !== "" || row.length > 0) {
          row.push(currentValue);
          result.push(row);
        }

        return result;
      };

      class Event {
        constructor(name, hook, description, date, location, linkInfo, link, startTime, endTime, icon, iconAlt, categories) {
          this.name = name;
          this.hook = hook;
          this.description = description;
          this.date = date;
          this.location = location;
          this.linkInfo = linkInfo;
          this.link = link;
          this.startTime = startTime;
          this.endTime = endTime;
          this.icon = icon;
          this.iconAlt = iconAlt;
          this.categories = categories;
        }
      }

      const events = [];
      const SHEET_ID = "1nfs459EuPLSICm9QbCI9EcQoyJ9T6hfXQPzogEYaW_4";
      const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

      async function fetchSheetData() {
        try {
          const response = await fetch(SHEET_URL);
          const csvText = await response.text();
          let semicolonCsv = csvText.replace(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/g, ";");

          // Parse CSV
          const rows = parseCSV(semicolonCsv);

          // Skip header row and process data
          for (let i = 1; i < rows.length; i++) {
            const name = rows[i][1] || "";
            const hook = rows[i][5] || "";
            const description = rows[i][6] || "";
            const date = rows[i][2] || "";
            const location = rows[i][4] || "";
            const linkInfo = rows[i][23] || "";
            const link = rows[i][24] || "";
            const incomplete = rows[i][26];
            const startTime = rows[i][3];
            const endTime = rows[i][28];
            const icon = rows[i][29];
            const iconAlt = rows[i][30];
            const categories = rows[i][10] ? rows[i][10].split(",") : [];

            if (incomplete) {
              continue;
            }

            if (events.some((event) => event.name === name)) {
              // add the date to the existing events date
              const existingEvent = events.find((event) => event.name === name);
              existingEvent.date += `, ${date}`;
              continue; // Skip duplicate events
            }

            if (!name || name == "Incomplete") {
              continue; // Skip incomplete rows
            }

            events.push(new Event(name, hook, description, date, location, linkInfo, link, startTime, endTime, icon, iconAlt, categories));
          }

          return events;
        } catch (error) {
          console.error("Error fetching sheet data:", error);
          return [];
        }
      }

      let currentDisplayingEvents = events;
      function displayEvents(events) {
        if (!events) {
          events = currentDisplayingEvents;
        } else {
          currentDisplayingEvents = events; // Update the current displaying events
        }

        const container = document.getElementById("schedule-container");
        container.innerHTML = ""; // Clear previous content

        events.forEach((event) => {
          const eventDiv = document.createElement("div");
          eventDiv.className = "event";

          eventDiv.innerHTML = `
            <section class="textBox2025">
              <img id="img2025" src="/images/TGW_Poster_Assets_2025/${event.icon}" alt="${event.icon}" class="eventIcon" />
              <h3 class="date" id="date2025">${event.date}, ${event.startTime}-${event.endTime}</h3>
              <div class="DescAndImg">
                <div class="desc">
                  <h2 class="title" id="title2025">${event.name}</h2>
                  <p class="details" id="description2025">
                    ${event.description}

                    <span id="linkBold2025"> ${event.link ? `<a href="${event.link}" target="_blank">${event.linkInfo}</a>` : `${event.linkInfo}`}
                    </span>
                  </p>
                </div>
              </div>

              <p class="location"><span aria-hidden="true">üìç</span>
                <a href="https://www.google.com/maps/search/${encodeURIComponent(event.location)}" 
                  target="_blank" 
                  title="View on Google Maps">
                  ${event.location}
                </a>
              </p>

              <p class="categoryContainer2025">
                ${event.categories
                  ?.map((category) => {
                    return `<span class="category2025">${category}</span>`;
                  })
                  .join("")}
                
              </p>
              
            </section>
          `;
          container.appendChild(eventDiv);
        });

        registerSaveEventButtons(); // Re-register buttons to ensure they work after DOM update
      }

      function registerDaySelectors() {
        // Add event listeners to buttons
        const buttons = document.querySelectorAll("[role='button']");
        buttons.forEach((button) => {
          button.addEventListener("click", (event) => {
            // Prevent default link behavior
            event.preventDefault();

            // Remove selected ID from all buttons
            buttons.forEach((btn) => {
              btn.id = "";
            });

            // Set selected ID to the clicked button
            event.currentTarget.id = "daySelectorSelected";

            // Check if this is the All Days button
            const day = event.currentTarget.getAttribute("data-day");
            if (day === "All") {
              // Show all events
              displayEvents(events);
              return;
            }

            // Otherwise, filter by the selected day
            const dayShort = day.split(" ")[0];
            const targetId = `#day${dayShort}`;
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: "smooth" });
            }

            // Rerender events for the selected day
            const filteredEvents = events.filter((event) => event.date.includes(dayShort));

            displayEvents(filteredEvents);
          });
        });

        // Set All Days button as selected by default
        const allDaysButton = document.querySelector("[data-day='All']");
        if (allDaysButton) {
          allDaysButton.id = "daySelectorSelected";
        }
      }

      function registerSaveEventButtons() {
        const saveButtons = document.querySelectorAll("button.saveEvent");
        // Remove existing listeners to avoid duplicates
        saveButtons.forEach((button) => {
          button.removeEventListener("click", () => {});
        });

        saveButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const eventName = event.currentTarget.getAttribute("data-event-name");

            const savedEvents = localStorage.getItem("savedEvents") ? JSON.parse(localStorage.getItem("savedEvents")) : [];

            if (savedEvents.includes(eventName)) {
              savedEvents.splice(savedEvents.indexOf(eventName), 1);
              localStorage.setItem("savedEvents", JSON.stringify(savedEvents));
            } else {
              savedEvents.push(eventName);
              localStorage.setItem("savedEvents", JSON.stringify(savedEvents));
            }

            displayEvents(); // Rerender events to reflect changes
            registerSaveEventButtons(); // Re-register buttons to ensure they work after DOM update
          });
        });
      }

      function showSavedEvents() {
        const savedEvents = localStorage.getItem("savedEvents") ? JSON.parse(localStorage.getItem("savedEvents")) : [];

        if (savedEvents.length === 0) {
          const saveEventButton = document.getElementById("showSavedEvents");
          return;
        }

        const filteredEvents = events.filter((event) => savedEvents.includes(event.name));

        displayEvents(filteredEvents);
      }

      function handleLoaded() {
        fetchSheetData()
          .then((events) => {
            displayEvents(events);
            registerDaySelectors();
            registerSaveEventButtons();

            const saveEventButton = document.getElementById("showSavedEvents");
            saveEventButton.addEventListener("click", (event) => {
              event.preventDefault(); // Prevent default link behavior
              showSavedEvents();
            });
          })
          .catch((error) => {
            console.error("Error displaying events:", error);
          });
      }

      // Call the function when the page loads
      document.addEventListener("DOMContentLoaded", handleLoaded);
    </script>
  </body>
</html>
